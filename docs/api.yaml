openapi: 3.0.0
info:
  title: Verba Backend API
  version: 1.0.0
  description: API contract for progress, exams, and rewards resources.
servers:
  - url: /api
tags:
  - name: Progress
  - name: Exams
  - name: Rewards

paths:
  /auth/register:
    post:
      tags: [Auth]
      summary: Register user (Firebase + local user)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AuthRegisterRequest'
      responses:
        '201':
          description: User registered
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string }
                  user: { $ref: '#/components/schemas/User' }

  /users:
    get:
      tags: [Users]
      summary: List users
      security:
        - bearerAuth: []
      responses:
        '200':
          description: List of users
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/User'
  /users/{id}:
    get:
      tags: [Users]
      summary: Get user by ID
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/UserId'
      responses:
        '200':
          description: User detail
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
    put:
      tags: [Users]
      summary: Update user
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/UserId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserUpdate'
      responses:
        '200':
          description: User updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
    delete:
      tags: [Users]
      summary: Delete user
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/UserId'
      responses:
        '200':
          description: User deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Message'

  /courses:
    get:
      tags: [Courses]
      summary: List courses
      responses:
        '200':
          description: List of courses
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Course'
    post:
      tags: [Courses]
      summary: Create course
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CourseCreate'
      responses:
        '201':
          description: Course created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Course'
  /courses/{id}:
    get:
      tags: [Courses]
      summary: Get course by ID
      parameters:
        - $ref: '#/components/parameters/CourseId'
      responses:
        '200':
          description: Course detail
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Course'
    put:
      tags: [Courses]
      summary: Update course
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/CourseId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CourseUpdate'
      responses:
        '200':
          description: Course updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Course'
    delete:
      tags: [Courses]
      summary: Delete course
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/CourseId'
      responses:
        '204':
          description: Course deleted

  /lessons/course/{courseId}:
    get:
      tags: [Lessons]
      summary: List lessons by course
      parameters:
        - $ref: '#/components/parameters/CourseId'
      responses:
        '200':
          description: Lessons in course
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Lesson'
  /lessons:
    post:
      tags: [Lessons]
      summary: Create lesson
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LessonCreate'
      responses:
        '201':
          description: Lesson created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Lesson'
  /lessons/{id}:
    get:
      tags: [Lessons]
      summary: Get lesson by ID
      parameters:
        - $ref: '#/components/parameters/LessonId'
      responses:
        '200':
          description: Lesson detail
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Lesson'
    put:
      tags: [Lessons]
      summary: Update lesson
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/LessonId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LessonCreate'
      responses:
        '200':
          description: Lesson updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Lesson'
    delete:
      tags: [Lessons]
      summary: Delete lesson
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/LessonId'
      responses:
        '200':
          description: Lesson deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Message'

  /progress:
    get:
      tags: [Progress]
      summary: List all progress
      responses:
        '200':
          description: List of progress records
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Progress'
    post:
      tags: [Progress]
      summary: Create progress
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProgressCreate'
      responses:
        '201':
          description: Progress created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Progress'
  /progress/{id}:
    get:
      tags: [Progress]
      summary: Get progress by ID
      parameters:
        - $ref: '#/components/parameters/ProgressId'
      responses:
        '200':
          description: Progress detail
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Progress'
    put:
      tags: [Progress]
      summary: Update progress
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/ProgressId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProgressUpdate'
      responses:
        '200':
          description: Progress updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Progress'
    delete:
      tags: [Progress]
      summary: Delete progress
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/ProgressId'
      responses:
        '200':
          description: Progress deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Message'
  /progress/user/{userId}:
    get:
      tags: [Progress]
      summary: List progress by user
      parameters:
        - $ref: '#/components/parameters/UserId'
      responses:
        '200':
          description: Progress entries for the user
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Progress'
  /progress/lesson/{lessonId}:
    get:
      tags: [Progress]
      summary: List progress by lesson
      parameters:
        - $ref: '#/components/parameters/LessonId'
      responses:
        '200':
          description: Progress entries for the lesson
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Progress'

  /exams:
    get:
      tags: [Exams]
      summary: List all exams
      responses:
        '200':
          description: List of exams
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Exam'
    post:
      tags: [Exams]
      summary: Create exam
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ExamCreate'
      responses:
        '201':
          description: Exam created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Exam'
  /exams/{id}:
    get:
      tags: [Exams]
      summary: Get exam by ID
      parameters:
        - $ref: '#/components/parameters/ExamId'
      responses:
        '200':
          description: Exam detail
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Exam'
  /exams/{id}/questions:
    post:
      tags: [Exams]
      summary: Add questions (MCQ or matching) to an exam
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/ExamId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: array
              items:
                $ref: '#/components/schemas/ExamQuestionUpsert'
      responses:
        '201':
          description: Questions created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExamWithQuestions'
    put:
      tags: [Exams]
      summary: Update exam
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/ExamId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ExamUpdate'
      responses:
        '200':
          description: Exam updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Exam'
    delete:
      tags: [Exams]
      summary: Delete exam
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/ExamId'
      responses:
        '200':
          description: Exam deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Message'

  /rewards:
    get:
      tags: [Rewards]
      summary: List all rewards
      responses:
        '200':
          description: List of rewards
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Reward'
    post:
      tags: [Rewards]
      summary: Create reward
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RewardCreate'
      responses:
        '201':
          description: Reward created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Reward'
  /rewards/{id}:
    get:
      tags: [Rewards]
      summary: Get reward by ID
      parameters:
        - $ref: '#/components/parameters/RewardId'
      responses:
        '200':
          description: Reward detail
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Reward'
    put:
      tags: [Rewards]
      summary: Update reward
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/RewardId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RewardUpdate'
      responses:
        '200':
          description: Reward updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Reward'
    delete:
      tags: [Rewards]
      summary: Delete reward
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/RewardId'
      responses:
        '200':
          description: Reward deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Message'
  /rewards/user/{userId}:
    get:
      tags: [Rewards]
      summary: List rewards by user
      parameters:
        - $ref: '#/components/parameters/UserId'
      responses:
        '200':
          description: Rewards for the user
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Reward'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  parameters:
    ProgressId:
      name: id
      in: path
      required: true
      schema:
        type: integer
    CourseId:
      name: id
      in: path
      required: true
      schema:
        type: integer
    ExamId:
      name: id
      in: path
      required: true
      schema:
        type: integer
    RewardId:
      name: id
      in: path
      required: true
      schema:
        type: integer
    UserId:
      name: userId
      in: path
      required: true
      schema:
        type: integer
    LessonId:
      name: lessonId
      in: path
      required: true
      schema:
        type: integer
  schemas:
    User:
      type: object
      properties:
        id: { type: integer }
        firebase_uid: { type: string }
        email: { type: string }
        name: { type: string }
        role: { type: string }
        photo_url: { type: string }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }
    UserUpdate:
      type: object
      properties:
        name: { type: string }
        role: { type: string }
        photo_url: { type: string }
    AuthRegisterRequest:
      type: object
      required: [email, password]
      properties:
        email: { type: string, format: email }
        password: { type: string, minLength: 6 }
        name: { type: string }
        photo_url: { type: string }

    Course:
      type: object
      properties:
        id: { type: integer }
        title: { type: string }
        description: { type: string }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }
    CourseCreate:
      type: object
      required: [title]
      properties:
        title: { type: string }
        description: { type: string }
    CourseUpdate:
      type: object
      properties:
        title: { type: string }
        description: { type: string }

    Lesson:
      type: object
      properties:
        id: { type: integer }
        course_id: { type: integer }
        title: { type: string }
        content: { type: string }
        order: { type: integer }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }
    LessonCreate:
      type: object
      required: [course_id, title]
      properties:
        course_id: { type: integer }
        title: { type: string }
        content: { type: string }
        order: { type: integer, default: 0 }

    Progress:
      type: object
      properties:
        id: { type: integer }
        user_id: { type: integer }
        lesson_id: { type: integer }
        completed: { type: boolean }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }
    ProgressCreate:
      type: object
      required: [user_id, lesson_id]
      properties:
        user_id: { type: integer }
        lesson_id: { type: integer }
        completed: { type: boolean, default: false }
    ProgressUpdate:
      type: object
      properties:
        completed: { type: boolean }
    Exam:
      type: object
      properties:
        id: { type: integer }
        course_id: { type: integer }
        title: { type: string }
        description: { type: string }
        total_questions: { type: integer }
        passing_score: { type: integer }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }
        questions:
          type: array
          items:
            $ref: '#/components/schemas/ExamQuestion'
    ExamCreate:
      type: object
      required: [course_id, title]
      properties:
        course_id: { type: integer }
        title: { type: string }
        description: { type: string }
        total_questions: { type: integer, default: 0 }
        passing_score: { type: integer, default: 0 }
        questions:
          type: array
          description: Optional bulk create of questions when creating the exam.
          items:
            $ref: '#/components/schemas/ExamQuestionUpsert'
    ExamUpdate:
      type: object
      properties:
        course_id: { type: integer }
        title: { type: string }
        description: { type: string }
        total_questions: { type: integer }
        passing_score: { type: integer }
    ExamQuestion:
      type: object
      properties:
        id: { type: integer }
        exam_id: { type: integer }
        type:
          type: string
          enum: [multiple_choice, matching]
        prompt: { type: string }
        options:
          type: array
          description: For multiple_choice questions.
          items:
            $ref: '#/components/schemas/ExamQuestionOption'
        pairs:
          type: array
          description: For matching questions; each pair maps left to right text.
          items:
            $ref: '#/components/schemas/ExamQuestionPair'
    ExamQuestionUpsert:
      type: object
      required: [type, prompt]
      properties:
        type:
          type: string
          enum: [multiple_choice, matching]
        prompt: { type: string }
        options:
          type: array
          description: Required for multiple_choice; provide at least one correct.
          items:
            $ref: '#/components/schemas/ExamQuestionOptionCreate'
        pairs:
          type: array
          description: Required for matching; list of pairs to match.
          items:
            $ref: '#/components/schemas/ExamQuestionPairCreate'
    ExamWithQuestions:
      allOf:
        - $ref: '#/components/schemas/Exam'
        - type: object
          properties:
            questions:
              type: array
              items:
                $ref: '#/components/schemas/ExamQuestion'
    ExamQuestionOption:
      type: object
      properties:
        id: { type: integer }
        question_id: { type: integer }
        text: { type: string }
        is_correct: { type: boolean }
    ExamQuestionOptionCreate:
      type: object
      required: [text]
      properties:
        text: { type: string }
        is_correct: { type: boolean, default: false }
    ExamQuestionPair:
      type: object
      properties:
        id: { type: integer }
        question_id: { type: integer }
        left_text: { type: string }
        right_text: { type: string }
    ExamQuestionPairCreate:
      type: object
      required: [left_text, right_text]
      properties:
        left_text: { type: string }
        right_text: { type: string }
    Reward:
      type: object
      properties:
        id: { type: integer }
        user_id: { type: integer }
        xp: { type: integer }
        source: { type: string }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }
    RewardCreate:
      type: object
      required: [user_id, xp]
      properties:
        user_id: { type: integer }
        xp: { type: integer, default: 0 }
        source: { type: string }
    RewardUpdate:
      type: object
      properties:
        user_id: { type: integer }
        xp: { type: integer }
        source: { type: string }
    Message:
      type: object
      properties:
        message: { type: string }
    Error:
      type: object
      properties:
        error: { type: string }
